<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin - Manage Clients</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-6">
  <h1 class="text-3xl font-extrabold mb-6 text-orange-400">Admin - Manage Clients</h1>

  <!-- Add/Edit Tenant Form -->
  <form id="addForm" class="space-y-4 mb-8 bg-gray-800 p-6 rounded-lg shadow-lg max-w-md mx-auto">
    <h2 class="text-xl font-bold mb-4 text-white">Add / Edit Tenant</h2>

    <select id="block" class="p-3 bg-gray-700 rounded w-full text-white">
      <option value="">Select Block</option>
      <option value="A">Block A</option>
      <option value="B">Block B</option>
      <option value="C">Block C</option>
    </select>

    <input id="floor" type="number" placeholder="Floor Number" class="p-3 bg-gray-700 rounded w-full text-white"/>

    <input id="name" type="text" placeholder="Tenant Name" class="p-3 bg-gray-700 rounded w-full text-white"/>
    <input id="logoUrl" type="url" placeholder="Logo Image URL" class="p-3 bg-gray-700 rounded w-full text-white"/>
    <input id="core" type="text" placeholder="Core" class="p-3 bg-gray-700 rounded w-full text-white"/>
    <textarea id="description" placeholder="Description" class="p-3 bg-gray-700 rounded w-full text-white"></textarea>
    <input id="contact" type="text" placeholder="Contact Number" class="p-3 bg-gray-700 rounded w-full text-white"/>
    <input id="email" type="email" placeholder="Email" class="p-3 bg-gray-700 rounded w-full text-white"/>

    <div class="flex gap-2">
      <button type="submit" class="bg-green-500 hover:bg-green-600 px-6 py-2 rounded font-semibold w-full">Save Tenant</button>
      <button type="button" id="cancelEdit" class="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded font-semibold w-full hidden">Cancel</button>
    </div>
  </form>

  <!-- Tenant List -->
  <h2 class="text-2xl font-bold mb-4 text-orange-400 text-center">Existing Tenants</h2>
  <div id="tenantList" class="space-y-4 max-w-3xl mx-auto"></div>

  <!-- Firebase + Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, push, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCrGIB_YK33p_2EPTpU-klZ_3xQ5TOPm4c",
      authDomain: "adora-ad.firebaseapp.com",
      databaseURL: "https://adora-ad-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "adora-ad"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    document.addEventListener("DOMContentLoaded", () => {
      const blockEl = document.getElementById("block");
      const floorEl = document.getElementById("floor");
      const tenantList = document.getElementById("tenantList");

      const nameEl = document.getElementById("name");
      const logoEl = document.getElementById("logoUrl");
      const coreEl = document.getElementById("core");
      const descEl = document.getElementById("description");
      const contactEl = document.getElementById("contact");
      const emailEl = document.getElementById("email");
      const addForm = document.getElementById("addForm");
      const cancelEditBtn = document.getElementById("cancelEdit");

      let editTenantId = null; // Track tenant being edited

      // Add/Edit Tenant
      addForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const block = blockEl.value;
        const floor = floorEl.value;
        const name = nameEl.value;
        const logo = logoEl.value;
        const core = coreEl.value;
        const description = descEl.value;
        const contact = contactEl.value;
        const email = emailEl.value;

        if (!block || !floor || !name) return alert("Fill at least block, floor, and name");

        const tenantData = { name, logo, core, description, contact, email };

        try {
          if (editTenantId) {
            await set(ref(db, `blocks/${block}/floors/${floor}/tenants/${editTenantId}`), tenantData);
            editTenantId = null;
            cancelEditBtn.classList.add("hidden");
          } else {
            const tenantRef = push(ref(db, `blocks/${block}/floors/${floor}/tenants`));
            await set(tenantRef, tenantData);
          }

          addForm.reset();
        } catch (err) {
          alert("Error: " + err.message);
        }
      });

      cancelEditBtn.addEventListener("click", () => {
        editTenantId = null;
        addForm.reset();
        cancelEditBtn.classList.add("hidden");
      });

      // Watch tenants
      function watchTenants() {
        const block = blockEl.value;
        const floor = floorEl.value;
        if (!block || !floor) {
          tenantList.innerHTML = "<p class='text-gray-400 text-center'>Select block and floor to view tenants.</p>";
          return;
        }

        const tenantsRef = ref(db, `blocks/${block}/floors/${floor}/tenants`);
        onValue(tenantsRef, (snapshot) => {
          const data = snapshot.val();
          tenantList.innerHTML = "";

          if (!data) {
            tenantList.innerHTML = "<p class='text-gray-400 text-center'>No tenants found.</p>";
            return;
          }

          Object.keys(data).forEach(tid => {
            const t = data[tid];
            const item = document.createElement("div");
            item.className = "flex items-center justify-between bg-gray-800 p-4 rounded-lg shadow-md";

            const left = document.createElement("div");
            left.className = "flex items-center gap-4";

            if (t.logo) {
              const logo = document.createElement("img");
              logo.src = t.logo;
              logo.className = "h-12 w-12 rounded";
              left.appendChild(logo);
            }

            const info = document.createElement("div");
            info.innerHTML = `<span class="font-bold text-lg">${t.name}</span><br><span class="text-sm text-gray-400">Floor: ${floor}</span>`;
            left.appendChild(info);

            item.appendChild(left);

            const right = document.createElement("div");
            right.className = "flex gap-2";

            // Edit Button
            const editBtn = document.createElement("button");
            editBtn.textContent = "Edit";
            editBtn.className = "bg-yellow-500 px-4 py-1 rounded hover:bg-yellow-600 text-sm";
            editBtn.onclick = () => {
              editTenantId = tid;
              nameEl.value = t.name;
              logoEl.value = t.logo || "";
              coreEl.value = t.core || "";
              descEl.value = t.description || "";
              contactEl.value = t.contact || "";
              emailEl.value = t.email || "";
              cancelEditBtn.classList.remove("hidden");
            };
            right.appendChild(editBtn);

            // Delete Button
            const delBtn = document.createElement("button");
            delBtn.textContent = "Delete";
            delBtn.className = "bg-red-600 px-4 py-1 rounded hover:bg-red-700 text-sm";
            delBtn.onclick = async () => {
              if (confirm(`Delete tenant ${t.name}?`)) {
                await remove(ref(db, `blocks/${block}/floors/${floor}/tenants/${tid}`));
              }
            };
            right.appendChild(delBtn);

            item.appendChild(right);
            tenantList.appendChild(item);
          });
        });
      }

      blockEl.addEventListener("change", watchTenants);
      floorEl.addEventListener("input", watchTenants);
    });
  </script>
</body>
</html>