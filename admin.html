<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin - Manage Tenants</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* Smooth iOS-like scrollbar */
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 20px; }
  ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

  /* iOS-like card hover */
  .card-hover:hover {
    transform: translateY(-2px);
    transition: all 0.2s ease;
    box-shadow: 0 6px 12px rgba(0,0,0,0.06);
  }

  /* iOS-like buttons */
  .btn-primary {
    background: #6366f1;
    color: white;
    font-weight: 600;
    border-radius: 12px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 6px rgba(99,102,241,0.3);
  }
  .btn-primary:hover {
    background: #4f46e5;
    transform: scale(1.02);
  }

  /* Input focus like iOS */
  input:focus, select:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 2px rgba(99,102,241,0.2);
  }

  /* Toast */
  #toast {
    position: fixed;
    bottom: 16px;
    right: 16px;
    background: #4f46e5;
    color: white;
    padding: 14px 20px;
    border-radius: 14px;
    font-weight: 500;
    display: none;
    z-index: 9999;
    animation: fadeInOut 3s forwards;
  }
  @keyframes fadeInOut {
    0% { opacity: 0; transform: translateY(20px);}
    10% { opacity: 1; transform: translateY(0);}
    90% { opacity: 1; transform: translateY(0);}
    100% { opacity: 0; transform: translateY(20px);}
  }
</style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">

<!-- Slim Header -->
<header class="bg-white border-b border-gray-200 p-4 text-center text-lg font-semibold shadow-sm">
  Tenant Management
</header>

<!-- Toast -->
<div id="toast"></div>

<!-- Add/Edit Tenant Form -->
<form id="addForm" class="space-y-6 mb-6 bg-white p-6 rounded-2xl shadow-md max-w-4xl mx-auto mt-6">
  <h2 class="text-lg font-semibold mb-4 text-gray-800">Add / Edit Tenant</h2>

  <!-- Force 2 columns always -->
  <div class="grid grid-cols-2 gap-4">
    <select id="block" class="p-3 bg-gray-50 rounded-xl w-full border border-gray-200 shadow-sm">
      <option value="A">Block A</option>
      <option value="B">Block B</option>
      <option value="C">Block C</option>
    </select>

    <select id="core" class="p-3 bg-gray-50 rounded-xl w-full border border-gray-200 shadow-sm"></select>

    <select id="floor" class="p-3 bg-gray-50 rounded-xl w-full border border-gray-200 shadow-sm">
      <option value="GF">GF</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10">10</option>
      <option value="11">11</option>
      <option value="12">12</option>
      <option value="13">13</option>
    </select>

    <input id="name" type="text" placeholder="Tenant Name" class="p-3 bg-gray-50 rounded-xl w-full border border-gray-200 shadow-sm"/>
    <input id="logoUrl" type="url" placeholder="Logo Image URL" class="p-3 bg-gray-50 rounded-xl w-full border border-gray-200 shadow-sm"/>
  </div>

  <div class="flex gap-4 mt-4">
    <button type="submit" class="btn-primary px-6 py-2 w-full">Save Tenant</button>
    <button type="button" id="cancelEdit" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-xl w-full hidden">Cancel</button>
  </div>
</form>

<!-- Tenant Filters -->
<div class="max-w-4xl mx-auto mb-6 bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
  <!-- Force 3 columns always -->
  <div class="grid grid-cols-3 gap-3 items-center">
    <select id="filterBlock" class="p-3 bg-gray-50 rounded-xl border border-gray-200 shadow-sm">
      <option value="">All Blocks</option>
      <option value="A">Block A</option>
      <option value="B">Block B</option>
      <option value="C">Block C</option>
    </select>
    <select id="filterCore" class="p-3 bg-gray-50 rounded-xl border border-gray-200 shadow-sm">
      <option value="">All Cores</option>
    </select>
    <input id="filterSearch" type="text" placeholder="Search Tenant" class="p-3 bg-gray-50 rounded-xl border border-gray-200 shadow-sm"/>
  </div>
</div>

<!-- Tenant List -->
<div id="tenantList" class="space-y-3 max-w-4xl mx-auto"></div>

<!-- Slim Footer -->
<footer class="bg-white border-t border-gray-200 p-4 text-center text-sm text-gray-500 mt-8">
  © 2025 Tenant Management
</footer>

<!-- Firebase + Script -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, set, push, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCrGIB_YK33p_2EPTpU-klZ_3xQ5TOPm4c",
    authDomain: "adora-ad.firebaseapp.com",
    databaseURL: "https://adora-ad-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "adora-ad"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const toast = document.getElementById('toast');
  function showToast(msg) {
    toast.textContent = msg;
    toast.style.display = 'block';
    setTimeout(() => toast.style.display = 'none', 3000);
  }

  document.addEventListener("DOMContentLoaded", () => {
    const blockEl = document.getElementById("block");
    const coreEl = document.getElementById("core");
    const floorEl = document.getElementById("floor");
    const tenantList = document.getElementById("tenantList");
    const nameEl = document.getElementById("name");
    const logoEl = document.getElementById("logoUrl");
    const addForm = document.getElementById("addForm");
    const cancelEditBtn = document.getElementById("cancelEdit");

    const filterBlock = document.getElementById("filterBlock");
    const filterCore = document.getElementById("filterCore");
    const filterSearch = document.getElementById("filterSearch");

    let editTenantId = null;
    let allTenants = [];

    function updateCoreOptions() {
      const block = blockEl.value;
      coreEl.innerHTML = "";
      let options = [];
      if (block === "A") options = ["Core-1", "Core-2"];
      else if (block === "B") options = ["No Core"];
      else if (block === "C") options = ["Core-1", "Core-2"];
      options.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        coreEl.appendChild(opt);
      });
    }

    function updateFilterCoreOptions() {
      const block = filterBlock.value;
      filterCore.innerHTML = "<option value=''>All Cores</option>";
      let options = [];
      if (block === "A") options = ["Core-1", "Core-2"];
      else if (block === "B") options = ["No Core"];
      else if (block === "C") options = ["Core-1", "Core-2"];
      options.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        filterCore.appendChild(opt);
      });
    }

    blockEl.addEventListener("change", updateCoreOptions);
    filterBlock.addEventListener("change", () => {
      updateFilterCoreOptions();
      renderTenants();
    });
    filterCore.addEventListener("change", renderTenants);
    filterSearch.addEventListener("input", renderTenants);

    addForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const block = blockEl.value;
      const core = coreEl.value;
      const floor = floorEl.value;
      const name = nameEl.value;
      const logo = logoEl.value;
      if (!block || !floor || !name) return showToast("Fill at least block, floor, and name");
      const tenantData = { name, logo, core, block, floor };
      try {
        if (editTenantId) {
          await set(ref(db, `blocks/${block}/floors/${floor}/tenants/${editTenantId}`), tenantData);
          editTenantId = null;
          cancelEditBtn.classList.add("hidden");
          showToast("Tenant updated!");
        } else {
          const tenantRef = push(ref(db, `blocks/${block}/floors/${floor}/tenants`));
          await set(tenantRef, tenantData);
          showToast("Tenant added!");
        }
        addForm.reset();
        updateCoreOptions();
      } catch (err) { showToast("Error: " + err.message); }
    });

    cancelEditBtn.addEventListener("click", () => {
      editTenantId = null;
      addForm.reset();
      cancelEditBtn.classList.add("hidden");
    });

    function fetchTenants() {
      const tenantsRef = ref(db, "blocks");
      onValue(tenantsRef, (snapshot) => {
        const data = snapshot.val();
        allTenants = [];
        if (data) {
          Object.keys(data).forEach(block => {
            const floors = data[block].floors || {};
            Object.keys(floors).forEach(floor => {
              const tenants = floors[floor].tenants || {};
              Object.keys(tenants).forEach(tid => {
                allTenants.push({ id: tid, ...tenants[tid], block, floor });
              });
            });
          });
        }
        renderTenants();
      });
    }

    function renderTenants() {
      const blockFilter = filterBlock.value;
      const coreFilter = filterCore.value;
      const searchFilter = filterSearch.value.toLowerCase();

      const filtered = allTenants.filter(t => {
        return (!blockFilter || t.block === blockFilter) &&
               (!coreFilter || t.core === coreFilter) &&
               (!searchFilter || t.name.toLowerCase().includes(searchFilter));
      });

      tenantList.innerHTML = "";
      if (filtered.length === 0) {
        tenantList.innerHTML = "<p class='text-gray-400 text-center'>No tenants found.</p>";
        return;
      }

      filtered.forEach(t => {
        const item = document.createElement("div");
        item.className = "flex items-center justify-between bg-white p-4 rounded-xl shadow-sm card-hover";

        const left = document.createElement("div");
        left.className = "flex items-center gap-3";
        if (t.logo) {
          const logo = document.createElement("img");
          logo.src = t.logo;
          logo.className = "h-10 w-10 rounded";
          left.appendChild(logo);
        }
        const info = document.createElement("div");
        info.innerHTML = `<span class="font-semibold text-base text-gray-800">${t.name}</span><br>
                          <span class="text-xs text-gray-500">Block ${t.block} • Floor ${t.floor} • ${t.core || 'N/A'}</span>`;
        left.appendChild(info);
        item.appendChild(left);

        const right = document.createElement("div");
        right.className = "flex gap-2";
        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.className = "bg-yellow-400 px-3 py-1 rounded text-xs";
        editBtn.onclick = () => {
          editTenantId = t.id;
          blockEl.value = t.block;
          updateCoreOptions();
          coreEl.value = t.core || "";
          floorEl.value = t.floor;
          nameEl.value = t.name;
          logoEl.value = t.logo || "";
          cancelEditBtn.classList.remove("hidden");
          window.scrollTo({ top: 0, behavior: "smooth" });
        };
        right.appendChild(editBtn);

        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.className = "bg-red-500 px-3 py-1 rounded text-xs text-white";
        delBtn.onclick = async () => {
          if (confirm(`Delete tenant ${t.name}?`)) {
            await remove(ref(db, `blocks/${t.block}/floors/${t.floor}/tenants/${t.id}`));
            showToast("Tenant deleted!");
          }
        };
        right.appendChild(delBtn);

        item.appendChild(right);
        tenantList.appendChild(item);
      });
    }

    updateCoreOptions();
    updateFilterCoreOptions();
    fetchTenants();
  });
</script>
</body>
</html>