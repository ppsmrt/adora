<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin - Manage Clients</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-6">
  <h1 class="text-2xl font-bold mb-4">Admin - Manage Clients</h1>

  <!-- Add Tenant Form -->
  <form id="addForm" class="space-y-4 mb-6">
    <select id="block" class="p-2 bg-gray-800 rounded w-full">
      <option value="">Select Block</option>
      <option value="A">Block A</option>
      <option value="B">Block B</option>
      <option value="C">Block C</option>
    </select>

    <input id="floor" type="number" placeholder="Floor Number" class="p-2 bg-gray-800 rounded w-full"/>

    <input id="name" type="text" placeholder="Tenant Name" class="p-2 bg-gray-800 rounded w-full"/>

    <input id="logo" type="file" accept="image/*" class="p-2 bg-gray-800 rounded w-full"/>

    <button type="submit" class="bg-green-600 px-4 py-2 rounded">Add Tenant</button>
  </form>

  <!-- Tenant List -->
  <h2 class="text-xl font-bold mb-2">Existing Tenants</h2>
  <div id="tenantList" class="space-y-2"></div>

  <!-- Firebase + Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, push, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // âœ… Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCrGIB_YK33p_2EPTpU-klZ_3xQ5TOPm4c",
      authDomain: "adora-ad.firebaseapp.com",
      databaseURL: "https://adora-ad-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "adora-ad"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    document.addEventListener("DOMContentLoaded", () => {
      const blockEl = document.getElementById("block");
      const floorEl = document.getElementById("floor");
      const tenantList = document.getElementById("tenantList");

      // Add Tenant
      document.getElementById("addForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const block = blockEl.value;
        const floor = floorEl.value;
        const name = document.getElementById("name").value;
        const file = document.getElementById("logo").files[0];

        if (!block || !floor || !name || !file) return alert("Fill all fields");

        const reader = new FileReader();
        reader.onload = async function () {
          const base64Logo = reader.result; // Base64 string (data:image/png;base64,...)

          try {
            const tenantRef = push(ref(db, `blocks/${block}/floors/${floor}/tenants`));
            await set(tenantRef, { name, logo: base64Logo });

            alert("Tenant Added!");
            e.target.reset();
          } catch (err) {
            alert("Error: " + err.message);
          }
        };
        reader.readAsDataURL(file);
      });

      // Watch tenants when block/floor is selected
      function watchTenants() {
        const block = blockEl.value;
        const floor = floorEl.value;
        if (!block || !floor) {
          tenantList.innerHTML = "<p class='text-gray-400'>Select block and floor to view tenants.</p>";
          return;
        }

        const tenantsRef = ref(db, `blocks/${block}/floors/${floor}/tenants`);
        onValue(tenantsRef, (snapshot) => {
          const data = snapshot.val();
          tenantList.innerHTML = "";

          if (!data) {
            tenantList.innerHTML = "<p class='text-gray-400'>No tenants found.</p>";
            return;
          }

          Object.keys(data).forEach(tid => {
            const t = data[tid];
            const item = document.createElement("div");
            item.className = "flex items-center justify-between bg-gray-800 p-3 rounded mb-2";

            const left = document.createElement("div");
            left.className = "flex items-center gap-3";

            if (t.logo) {
              const logo = document.createElement("img");
              logo.src = t.logo;
              logo.className = "h-8 w-auto rounded";
              left.appendChild(logo);
            }

            const name = document.createElement("span");
            name.textContent = t.name;
            left.appendChild(name);

            item.appendChild(left);

            const delBtn = document.createElement("button");
            delBtn.textContent = "Delete";
            delBtn.className = "bg-red-600 px-3 py-1 rounded text-sm hover:bg-red-700";
            delBtn.onclick = async () => {
              if (confirm(`Delete tenant ${t.name}?`)) {
                await remove(ref(db, `blocks/${block}/floors/${floor}/tenants/${tid}`));
              }
            };
            item.appendChild(delBtn);

            tenantList.appendChild(item);
          });
        });
      }

      blockEl.addEventListener("change", watchTenants);
      floorEl.addEventListener("input", watchTenants);
    });
  </script>
</body>
</html>
