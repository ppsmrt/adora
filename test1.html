<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Adora — Premium Tenant Display</title>
  <style>
    /* Reset */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body,#app{height:100%}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;overflow:hidden;background:#000;color:#fff}/* Background animated gradient */
.bg-gradient{
  position:fixed;inset:0;z-index:0;transform:translateZ(0);background:linear-gradient(120deg,#0f172a,#001219);
  background-size:400% 400%;animation:grad 20s linear infinite;
  filter:blur(8px) saturate(120%);
}
@keyframes grad{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

/* Particle canvas sits above bg */
canvas#particles{position:fixed;left:0;top:0;width:100%;height:100%;z-index:1;pointer-events:none;opacity:.25}

/* Main container */
#app{position:relative;z-index:2;display:flex;align-items:center;justify-content:center;height:100vh;padding:32px}

.stage{width:100%;height:100%;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}

/* Card styles */
.card{width:min(1200px,92%);height:min(720px,86%);display:flex;align-items:center;justify-content:space-between;padding:36px;border-radius:20px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));box-shadow:0 10px 40px rgba(2,6,23,0.6);backdrop-filter:blur(6px);overflow:hidden}

.left{flex:0 0 48%;display:flex;flex-direction:column;gap:18px}
.logo-wrap{width:100%;height:60%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.02);border-radius:14px;padding:20px}
.logo-wrap img{max-width:100%;max-height:100%;object-fit:contain;border-radius:10px;filter:drop-shadow(0 6px 18px rgba(0,0,0,.6))}

.meta{display:flex;flex-direction:column;gap:8px}
.name{font-size:40px;font-weight:800;letter-spacing:0.6px}
.core{font-size:14px;color:rgba(255,255,255,0.7);padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);display:inline-block}
.desc{font-size:16px;color:rgba(255,255,255,0.85);line-height:1.35;max-height:90px;overflow:hidden}

.right{flex:0 0 46%;height:100%;display:flex;flex-direction:column;gap:12px;align-items:flex-end}
.ticker{width:100%;display:flex;flex-direction:column;align-items:flex-end}
.small{font-size:14px;color:rgba(255,255,255,0.7)}

.dir-grid{width:100%;height:100%;display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;padding:8px;align-content:start}
.tenant-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.008));border-radius:10px;padding:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;min-height:120px}
.tenant-card img{width:100%;height:72px;object-fit:contain}
.tenant-name{font-size:13px;text-align:center}

/* Announcement / Ad full-screen */
.overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.65);z-index:4;padding:20px}
.overlay img{max-width:calc(100% - 120px);max-height:calc(100% - 120px);object-fit:contain;border-radius:8px;box-shadow:0 20px 60px rgba(0,0,0,0.6)}

/* Animations */
.fade-in{animation:fadeIn .8s cubic-bezier(.22,.9,.35,1) both}
.slide-up{animation:slideUp .8s cubic-bezier(.22,.9,.35,1) both}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(18px);opacity:0}to{transform:none;opacity:1}}

/* Small responsive tweaks */
@media (max-width:900px){.card{flex-direction:column;height:auto;padding:20px}.left,.right{flex:unset;width:100%}.logo-wrap{height:220px}}

/* Bottom status bar */
.status{position:absolute;left:18px;right:18px;bottom:18px;height:48px;display:flex;align-items:center;justify-content:space-between;gap:12px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:8px 14px;border-radius:10px}
.progress{height:6px;background:rgba(255,255,255,0.06);border-radius:999px;overflow:hidden;flex:1}
.progress > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#ffd166,#ef476f);transition:width .3s linear}
.status .meta-right{display:flex;gap:12px;align-items:center}

  </style>
</head>
<body>
  <div class="bg-gradient"></div>
  <canvas id="particles"></canvas>  <div id="app">
    <div class="stage"><!-- Main card (Intro / Directory) -->
  <div id="card" class="card fade-in">
    <div class="left">
      <div class="logo-wrap" id="logoWrap">
        <img id="logoImage" src="https://via.placeholder.com/512x256?text=Loading" alt="logo">
      </div>

      <div class="meta">
        <div style="display:flex;align-items:center;gap:12px;justify-content:space-between">
          <div>
            <div id="tenantName" class="name">Loading…</div>
            <div id="tenantCore" class="core">Core</div>
          </div>
        </div>
        <div id="tenantDesc" class="desc">Waiting for content from Firebase</div>
      </div>
    </div>

    <div class="right">
      <div class="ticker small">Announcements show as full screen interrupts</div>

      <div id="directory" class="dir-grid" style="width:100%;height:100%;"></div>
    </div>
  </div>

  <!-- Overlay for Ads / Announcements -->
  <div id="overlay" class="overlay" style="display:none">
    <img id="overlayImage" src="" alt="overlay">
  </div>

  <div class="status">
    <div class="small">Adora Display — Premium View</div>
    <div class="progress" aria-hidden="true"><i id="progBar" style="width:0%"></i></div>
    <div class="meta-right small" id="statusRight">Status: idle</div>
  </div>

</div>

  </div>  <!-- Firebase + App Script -->  <script type="module">
    // Firebase imports (modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // --- Firebase config (from you) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCrGIB_YK33p_2EPTpU-klZ_3xQ5TOPm4c",
      authDomain: "adora-ad.firebaseapp.com",
      databaseURL: "https://adora-ad-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "adora-ad",
      storageBucket: "adora-ad.firebasestorage.app",
      messagingSenderId: "550034277527",
      appId: "1:550034277527:web:966b16ce942a161e8955d2",
      measurementId: "G-QW5Y41EKLR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM refs
    const logoImage = document.getElementById('logoImage');
    const tenantName = document.getElementById('tenantName');
    const tenantCore = document.getElementById('tenantCore');
    const tenantDesc = document.getElementById('tenantDesc');
    const directory = document.getElementById('directory');
    const overlay = document.getElementById('overlay');
    const overlayImage = document.getElementById('overlayImage');
    const progBar = document.getElementById('progBar');
    const statusRight = document.getElementById('statusRight');

    // Data holders
    let tenants = []; // list of tenant objects
    let ads = []; // list of ad image urls
    let announcements = []; // announcement images

    // Playback config
    const INTRO_DURATION = 10000; // ms
    const AD_AFTER = 5; // after every 5 intros
    const AD_DURATION = 15000; // ms (default, auto-override by admin if needed)
    const DIRECTORY_DURATION = 40000; // ms
    const ANNOUNCE_DURATION = 60000; // ms

    // Playback state
    let playIndex = 0;
    let loopTimer = null;
    let introCounter = 0;
    let currentMode = 'idle';
    let adIndex = 0;
    let isAnnouncementPlaying = false;

    // Utility: flatten blocks -> floors -> tenants
    function parseTenants(blockObj){
      const out = [];
      if(!blockObj) return out;
      Object.keys(blockObj).forEach(blockKey =>{
        const block = blockObj[blockKey];
        const floors = (block.floors) || {};
        Object.keys(floors).forEach(floorKey =>{
          const floor = floors[floorKey];
          const tnts = (floor.tenants) || {};
          Object.keys(tnts).forEach(tid =>{
            const t = tnts[tid];
            out.push({
              id: tid,
              block: blockKey,
              floor: floorKey,
              name: t.name || 'Unnamed',
              logo: t.logo || 'https://via.placeholder.com/512x256?text=No+Logo',
              description: t.description || '',
              contact: t.contact || '',
              email: t.email || '',
              core: t.core || ''
            });
          })
        })
      })
      return out;
    }

    // Listen to Firebase nodes
    onValue(ref(db, 'blocks'), snap =>{
      const val = snap.val();
      tenants = parseTenants(val);
      console.log('tenants loaded', tenants.length);
      buildDirectory();
      if(tenants.length && currentMode==='idle') startLoop();
    });

    onValue(ref(db, 'ads'), snap =>{
      const val = snap.val() || {};
      ads = Object.keys(val).map(k=>val[k].image).filter(Boolean);
      console.log('ads', ads.length);
    });

    onValue(ref(db, 'announcements'), snap =>{
      const val = snap.val() || {};
      announcements = Object.keys(val).map(k=>val[k].image).filter(Boolean);
      console.log('announcements', announcements.length);
      // Immediately trigger announcement if present
      if(announcements.length){
        playAnnouncement(announcements[0]);
      }
    });

    // Build directory tiles
    function buildDirectory(){
      directory.innerHTML = '';
      tenants.forEach(t=>{
        const el = document.createElement('div');
        el.className = 'tenant-card slide-up';
        el.innerHTML = `<img src="${t.logo}" alt="${escapeHtml(t.name)}" /><div class="tenant-name">${escapeHtml(t.name)}</div>`;
        directory.appendChild(el);
      })
    }

    // Escape helper
    function escapeHtml(s){return (s||'').toString().replace(/[&<>"]+/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]||c))}

    // Playback controller
    function startLoop(){
      if(currentMode !== 'idle') return;
      currentMode = 'loop';
      statusRight.textContent = 'Status: running';
      playIndex = 0;
      introCounter = 0;
      scheduleNextIntro(0);
    }

    function scheduleNextIntro(delay){
      clearTimeout(loopTimer);
      loopTimer = setTimeout(()=>{
        if(isAnnouncementPlaying) return; // announcement has priority
        if(tenants.length===0){scheduleNextIntro(2000);return}
        showIntro(playIndex);
      }, delay);
    }

    function showIntro(idx){
      const t = tenants[idx % tenants.length];
      // Update UI
      logoImage.src = t.logo;
      tenantName.textContent = t.name;
      tenantCore.textContent = t.core || '';
      tenantDesc.textContent = t.description || '';
      // small animation classes
      const card = document.getElementById('card');
      card.classList.remove('fade-in');void card.offsetWidth;card.classList.add('fade-in');

      // progress bar anim
      animateProgress(INTRO_DURATION);

      // schedule next
      playIndex = (idx + 1) % tenants.length;
      introCounter++;

      // After AD_AFTER intros -> show ad
      if(introCounter >= AD_AFTER){
        introCounter = 0;
        setTimeout(()=>playAd(), INTRO_DURATION);
      } else {
        scheduleNextIntro(INTRO_DURATION);
      }
    }

    function playAd(){
      if(ads.length===0){ scheduleNextIntro(0); return; }
      const ad = ads[adIndex % ads.length];
      adIndex++;
      playOverlay(ad, AD_DURATION, 'Ad');
    }

    function playDirectory(){
      // Show directory prominently by ensuring directory tiles visible and descriptive area tweaked
      // We can add a subtle animation toggle
      const dirEls = directory.querySelectorAll('.tenant-card');
      dirEls.forEach((el,i)=> el.style.opacity=1);
      animateProgress(DIRECTORY_DURATION);
      statusRight.textContent = `Status: directory (${tenants.length} tenants)`;

      clearTimeout(loopTimer);
      loopTimer = setTimeout(()=>{
        if(isAnnouncementPlaying) return;
        // restart loop after directory
        startLoop();
      }, DIRECTORY_DURATION);
    }

    function playAnnouncement(imgUrl){
      if(!imgUrl || isAnnouncementPlaying) return;
      isAnnouncementPlaying = true;
      // show overlay
      overlayImage.src = imgUrl;
      overlay.style.display = 'flex';
      statusRight.textContent = 'Status: announcement';
      animateProgress(ANNOUNCE_DURATION);

      // Pause other timers
      clearTimeout(loopTimer);
      setTimeout(()=>{
        overlay.style.display = 'none';
        isAnnouncementPlaying = false;
        statusRight.textContent = 'Status: running';
        // After announcement finishes, show directory for a full cycle
        playDirectory();
      }, ANNOUNCE_DURATION);
    }

    // Generic overlay player (ads/announcements share same UI)
    function playOverlay(imgUrl, duration, label='Overlay'){
      overlayImage.src = imgUrl;
      overlay.style.display = 'flex';
      statusRight.textContent = `Status: ${label}`;
      animateProgress(duration);
      clearTimeout(loopTimer);
      loopTimer = setTimeout(()=>{
        overlay.style.display = 'none';
        // after ad -> continue loop; after ad cycle if we've shown enough intros maybe show directory
        // we'll continue with next intro and if we've looped fully, show directory once
        scheduleNextIntro(0);
      }, duration);
    }

    // Progress bar helper: smoothly animate width from 0 to 100% over ms
    let progAnim = null;
    function animateProgress(ms){
      if(progAnim) { cancelAnimationFrame(progAnim); }
      const start = performance.now();
      function step(now){
        const pct = Math.min(1, (now - start) / ms) * 100;
        progBar.style.width = pct + '%';
        if(pct < 100) progAnim = requestAnimationFrame(step);
      }
      progAnim = requestAnimationFrame(step);
    }

    // Periodically show directory once per full cycle: we'll approximate by scheduling after N intros -> directory
    // For simplicity: after each ads cycle (i.e., after AD_AFTER intros & ad), show directory every time we complete adIndex modulo some value
    // But to match your requirement 'Tenant directory full - 40s' as part of loop, we'll schedule directory after we've shown all tenants once.

    // Simple approach: when playIndex wraps to 0 (we completed full loop), show directory before continuing
    // For that we'll detect whenever playIndex === 0 after increment; we will then play directory.
    // To do this we modify showIntro schedule: after updating playIndex above, if playIndex===0 -> schedule directory

    // Let's override scheduleNextIntro to check for wrap
    const originalScheduleNextIntro = scheduleNextIntro;
    scheduleNextIntro = function(delay){
      clearTimeout(loopTimer);
      loopTimer = setTimeout(()=>{
        if(isAnnouncementPlaying) return;
        if(tenants.length===0){scheduleNextIntro(2000);return}
        // If playIndex === 0, we've wrapped and should show directory
        if(playIndex === 0){
          playDirectory();
        } else {
          showIntro(playIndex);
        }
      }, delay);
    }

    // Small touch: if directory is requested externally, show now
    window.showDirectoryNow = playDirectory;

    // Initial status
    statusRight.textContent = 'Status: waiting for content...';

    // Simple announcement trigger when new announcements arrive: the onValue handler above already calls playAnnouncement

    // --- Particles ---
    (function particles(){
      const canvas = document.getElementById('particles');
      const ctx = canvas.getContext('2d');
      let W = canvas.width = innerWidth;
      let H = canvas.height = innerHeight;
      const particles = [];
      const PARTICLE_COUNT = Math.max(20, Math.floor((W*H)/100000));

      function rand(min,max){return Math.random()*(max-min)+min}
      function init(){
        particles.length = 0;
        for(let i=0;i<PARTICLE_COUNT;i++){
          particles.push({x:Math.random()*W,y:Math.random()*H,r:rand(0.6,2.2),vx:rand(-0.3,0.3),vy:rand(-0.2,0.2),alpha:rand(0.06,0.18)})
        }
      }
      function resize(){W=canvas.width=innerWidth;H=canvas.height=innerHeight;init()}
      window.addEventListener('resize', resize);

      function loop(){
        ctx.clearRect(0,0,W,H);
        for(const p of particles){
          p.x += p.vx; p.y += p.vy;
          if(p.x<0) p.x = W; if(p.x>W) p.x=0; if(p.y<0) p.y=H; if(p.y>H) p.y=0;
          ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fillStyle = `rgba(255,255,255,${p.alpha})`; ctx.fill();
        }
        requestAnimationFrame(loop);
      }
      init(); loop();
    })();

    // Kick off if data already present
    // If RTDB had data on initial load, onValue handlers will call startLoop()

  </script></body>
</html>